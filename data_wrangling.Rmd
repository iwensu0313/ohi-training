---
title: "Data Wrangling Training"
author: "Iwen Su"
date: "3/6/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro to Data Wrangling

### Wrangle gapminder data using `dplyr`.

First load the packages.

```{r load, message=FALSE}

library(tidyverse)
library(skimr)

```

### Get data from github.

```{r data, message=FALSE}

gapminder <- readr::read_csv("https://raw.githubusercontent.com/OHI-Science/data-science-training/master/data/gapminder.csv")

```

### Explore gapminder data.

```{r explore}

head(gapminder)
tail(gapminder)

head(gapminder, 10) # see the first ten rows
tail(gapminder, 12) # see the last twelve rows

## See structure and other info about the data frame
str(gapminder)
names(gapminder) 
dim(gapminder) 
c(nrow(gapminder), ncol(gapminder)) # create dim() from nrow() and ncol()

## summary statistics
summary(gapminder)
skim(gapminder) 


```

> Note: In addition to what data.frames can store, tibble can store lists, ggplots, and multiple dataframes.

Explore inside the dataframe `$`

```{r}

head(gapminder$lifeExp, 10)
str(gapminder$lifeExp) # more useful function for looking at entire dataset
summary(gapminder$lifeExp)
skim(gapminder$lifeExp)

```

### Dplyr basics: 

Main functions include: `filter()`, `select()`, `mutate()`, `summarise()`, and `arrange()`. See dplyr [cheatsheet](http://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf).

```{r}

filter(gapminder, lifeExp < 29)

# Filter for 1 country
filter(gapminder, country == "Mexico")

# Filter for multiple countries - use the `%in%` operator on `c()`
filter(gapminder, country %in% c("Mexico", "Chile"))

# Filter for 1 country in a specific year
filter(gapminder, country == "Mexico", year == 2002)

# Select by columns
select(gapminder, year, lifeExp)

# Use the `-` to deselect columns
select(gapminder, -continent, -lifeExp)

# Use filter and select together
gap_cambodia <- filter(gapminder, country == "Cambodia") 
gap_cambodia2 <- select(gap_cambodia, -lifeExp, -continent)

```

### Life changing pipe operator `%>%` (and then)

```{r}

gapminder %>% head() # equivalent to head(gapminder)

gapminder %>% head(3) # equivalent to head(gapminder, 3)

# Use filter and select together 
gap_cambodia <- filter(gapminder, country == "Cambodia") 
gap_cambodia2 <- select(gap_cambodia, -lifeExp, -continent)

# now let's do that with the %>% operator
gap_cambodia <- gapminder %>% 
  filter(country == "Cambodia")

gap_cambodia2 <- gap_cambodia %>% 
  select(-lifeExp, -continent)

# or you could combine the two variables created above by stacking `%>%` operators
gap_cambodia3 <- gapminder %>% 
  filter(country == "Cambodia") %>% 
  select(-continent, -lifeExp)

```

### To add variables use `mutate()`

* You can run other functions inside the `mutate()` function
* You can also run mathematical operations on existing columns

```{r}

gapminder %>% 
  mutate(index = 1:nrow(gapminder))

gapminder %>% 
  mutate(gdp = pop*gdpPercap) # can't call 'pop' or 'gdpPercap' by itself

```

### Exercise: Find the maximum gdpPercap of Egypt and Vietnam, and save it in a new column

1. First filter for Egypt and Vietnam
2. Then use `mutate` to create a new column that has the max GDP between Egypt and Vietnam together
3. What if we want the max GDP of Egypt and max GDP of Vietnam separately? Use `group_by`

```{r}

# Find max GDP per capita of both Egypt and Vietnam
gapminder %>% 
  filter(country %in% c("Egypt","Vietnam")) %>% 
  mutate(max_gdp = max(gdpPercap))

# Find max GDP per capita of Egypt and Vietnam separately
x2 <- gapminder %>% 
  filter(country %in% c("Egypt","Vietnam")) %>% 
  group_by(country) %>% 
  mutate(max_gdp = max(gdpPercap)) %>% 
  ungroup() # important to remember to ungroup

str(x2)

```

### Summarize and `group_by` together

While it can be nice to replicate the `max_gdp` value for each observation especially when you are running commands on all the observations, you may also want to just select the single value of max gdp for each country.

> Note: 'CTRL+I' is the shortcut for reindenting lines.

```{r}

gapminder %>% 
  group_by(country) %>% 
  mutate(gdp = pop*gdpPercap) %>% 
  summarize(max_gdp = max(gdp)) %>% 
  ungroup() %>% 
  arrange(max_gdp) # ascending order

gapminder %>% 
  group_by(country) %>% 
  mutate(gdp = pop*gdpPercap) %>% 
  summarize(max_gdp = max(gdp)) %>% 
  ungroup() %>% 
  arrange(desc(max_gdp)) # descending order



```

Let's find the max lifeExp for countries in Asia

```{r}

# Grab max GDP for just countries in Asia
asia <- gapminder %>% 
  filter(continent == "Asia") %>% 
  group_by(country) %>% 
  mutate(gdp = pop*gdpPercap) %>% 
  summarize(max_gdp = max(gdp)) %>% 
  ungroup() %>% 
  arrange(desc(max_gdp)) # descending order

# Grab max life expectancy for countries in Asia
gapminder %>% 
  filter(continent == "Asia") %>% 
  group_by(country) %>% 
  summarize(max_gdp = max(lifeExp)) %>% 
  ungroup() %>% 
  dplyr::arrange(desc(max_gdp)) # descending order


```


